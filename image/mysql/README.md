## General
This layer can be used to build a MySQL image, but also to add a database to our WildFly image.
One difference to the [official MySQL image](https://hub.docker.com/_/mysql) is the ability to process sql files via the
SQL mount even after initialization.

## Relevant ENV Variables
| Category   | Varaible                      | Available values or scheme | Default |
|------------|-------------------------------|----------------------------|---------|
| Security   | MYSQL_ROOT_PASSWORD           | \<STRING\>                 | root    |
| Logging    | MYSQL_GENERAL_LOG             | 0, 1                       | 0       |
| Logging    | MYSQL_SLOW_QUERY_LOG          | 0, 1                       | 0       |
| Optimizing | MYSQL_OPTS                    | \<STRING\>                 | -       |
| Updating   | MYSQL_UPDATE_SCANNER_ENABLED  | true \| false              | false   |
| Updating   | MYSQL_UPDATE_SCANNER_INTERVAL | \<NUMBER\>                 | 30      |

The variable `MYSQL_OPTS` in particular is comparable to `JAVA_OPTS`,
where additional parameters can be specified that are to be taken into account when MySQL is started.
For example, the memory requirement can simply be specified with: `MYSQL_OPTS=--innodb_buffer_pool_size=10G`.


## Relevant Entrypoints
| Path                          | ref. ENV-Variable       | Type (Permission) | Default                | Purpose                                                                                                                             |
|-------------------------------|-------------------------|-------------------|------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| /entrypoint-mysql-sqls        | ENTRY_MYSQL_SQLS        | directory (r)     | -                      | All SQL-files that are to be executed at the first start for database preparation are placed here.                                  |
| /entrypoint-mysql-update-sqls | ENTRY_MYSQL_UPDATE_SQLS | directory (r/w)   | -                      | Is only required if MYSQL_UPDATE_SCANNER_INTERVAL=true, then all SQL-files that are stored here are imported during operation.      |
| /entrypoint-mysql-data        | ENTRY_MYSQL_DATADIR     | directory (r/w)   | -                      | This directory can be mounted in an external volume so that data is not lost after delete container.                                |
| /entrypoint-mysql-my-cnf      | ENTRY_MYSQL_MY_CNF      | file (r)          | ${MYSQL_HOME}/my.cnf   | The `my.cnf` file contains all settings that are relevant for the operation of the MySQL-database and can be exchanged accordingly. |
| /entrypoint-mysql-socket      | ENTRY_MYSQL_SOCKET      | directory (r/w)   | -                      | The MySQL-socket is only relevant for accessing the database if no port is available.                                               |
| /entrypoint-mysql-logs        | ENTRY_MYSQL_LOGS        | Symlink (r/w)     | /entrypoint-logs/mysql | All logs generated by the MySQL service are stored here.                                                                            |


## Usage Docker
```shell
# build java-image
> cd images/mysql
> docker build --tag="mosaicgreifswald/mysql" --file="Dockerfile.mysql.8" .

# "versions" shows all installed tools and components, with their versions
> docker run --rm mosaicgreifswald/mysql versions
  last updated               : 2025-01-09 09:59:53
  Architecture               : x86_64
  Distribution               : Debian GNU/Linux 12.8
  MySQL-Server               : 8.4.3
  
# "entrypoints" lists all registered entrypoints
> docker run --rm mosaicgreifswald/mysql entrypoints
  ENTRY_LOGS                   : /entrypoint-logs
  ENTRY_MYSQL_DATADIR          : /entrypoint-mysql-data
  ENTRY_MYSQL_SQLS             : /entrypoint-mysql-sqls
  ENTRY_MYSQL_UPDATE_SQLS      : /entrypoint-mysql-update-sqls
  ENTRY_MYSQL_MY_CNF           : /entrypoint-mysql-my-cnf
  ENTRY_MYSQL_SOCKET           : /entrypoint-mysql-socket
  ENTRY_MYSQL_LOGS             : /entrypoint-mysql-logs

# simple start with your init-sqls and mysql-configuration, as well as locally stored db-data and logs
> docker run --rm -it \
    -e MYSQL_ROOT_PASSWORD=top-secret \
    -p 3306:3306 \
    -v /path/to/your/db-data:/entrypoint-mysql-data \
    -v /path/to/your/sqls:/entrypoint-mysql-sqls \
    -v /path/to/your/update-sqls:/entrypoint-mysql-update-sqls \
    -v /path/to/your/my.cnf:/entrypoint-mysql-my-cnf \
    -v /path/to/your/logs:/entrypoint-mysql-logs \
    mosaicgreifswald/mysql
```

## Change write permissions
If data is stored on the host-system (via volume), it is created by default with the internal mosaic-user (UID:GID = 1111:1111).
Accordingly, the writable directories on the host-system must be unlocked for the mosaic-user.

```sh
# at host-system
chown -R 1111:1111 db-data logs
```

### The alternative, change write-user
You can change the write-user by using the Docker parameter --user/-u.

```sh
# change write-user (UID:GID) for writable volumes
> mkdir /path/to/your/db-data
> chown 1006:1001 /path/to/your/db-data
> docker run --rm -d -u 1006:1001 -v /path/to/your/db-data:/entrypoint-mysql-data mosaicgreifswald/mysql

> ls -la /path/to/your/db-data
insgesamt 104552
drwxr-xr-x  7 1006 1001     4096  9. Jan 10:29  .
drwxrwxrwt 10 root root     4096  9. Jan 10:29  ..
-rw-r-----  1 1006 1001     1553  9. Jan 10:29  224fec23b202.err
-rw-r-----  1 1006 1001        4  9. Jan 10:29  224fec23b202.pid
-rw-r-----  1 1006 1001       56  9. Jan 10:29  auto.cnf
-rw-r-----  1 1006 1001      867  9. Jan 10:29  binlog.000001
-rw-r-----  1 1006 1001      158  9. Jan 10:29  binlog.000002
-rw-r-----  1 1006 1001       32  9. Jan 10:29  binlog.index
-rw-------  1 1006 1001     1705  9. Jan 10:29  ca-key.pem
...
```


## Usage with Docker compose
```yml
# docker-compose.yml
version: '3'
services:
  mysql:
    image: mosaicgreifswald/mysql
    ports:
      - 3306:3306
    environment:
      MYSQL_ROOT_PASSWORD: top-secret
    env_file:
      - ./envs/wf_commons.env
    volumes:
      - ./db-data:/entrypoint-mysql-data
      - ./sqls:/entrypoint-mysql-sqls
      - ./update-sqls:/entrypoint-mysql-update-sqls
      - ./my.cnf:/entrypoint-mysql-my-cnf
      - ./logs:/entrypoint-mysql-logs
```

## Additional files
```shell
# see all additional files
> docker run --rm -it mosaicgreifswald/mysql bash -c "cd /entrypoint-help-and-usage; ls -lah; bash"

# or copy all to local host
> docker run --rm -v "$(pwd)":"$(pwd)" mosaicgreifswald/mysql bash -c "cp -R /entrypoint-help-and-usage $(pwd)/help-and-usage"
```
You will receive the following directory-tree and can start playing immediately:
```
├─┬─ layer-readme/
│ ├─── README-debian.md
│ └─── README-mysql.md
└─┬─ examples/
  ├─┬─ compose-mysql-empty/
  │ ├─── db-data/
  │ ├─┬─ envs/
  │ │ └─── ttp_mysql.env
  │ ├─── logs/
  │ ├─── sqls/
  │ ├─── my.cnf
  │ └─── docker-compose.yml
  └─┬─ pure-envs/
    ├─── debian.env
    └─── ttp_mysql.env
```


## Current Software-Versions on this Image
| Date                   | Tags                                                                                                                                                                 | Changes                                                                                              |
|------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|
| 2025-01-09<br><br><br><br> | `8.4.3`, `8`, `latest` ([Dockerfile](https://github.com/mosaic-hgw/Docker/blob/488f661e0204675dc70da96e1436d1893ae57f0f/image/mysql/Dockerfile.mysql.8))<br><br><br><br> | **Debian** 12.8 "bookworm"<br>**MySQL-Server** 8.4.3<br>**added** support for docker-parameter --user/-u<br>**added** sql-update-strategy |
| 2024-09-09<br><br>     | `8.4.2` ([Dockerfile](https://github.com/mosaic-hgw/Docker/blob/dcb3c640768bc75158866466b4c7565de1f6a509/image/mysql/Dockerfile.mysql.8))<br><br>                    | **Debian** 12.7 "bookworm"<br>**MySQL-Server** 8.4.2                                                 |
| 2024-07-22<br><br>     | `8.4.1` ([Dockerfile](https://github.com/mosaic-hgw/Docker/blob/d66574b99dfe376a80bb1ca3ff86c3103991cb4f/image/mysql/Dockerfile.mysql.8))<br><br>                    | **Debian** 12.6 "bookworm"<br>**MySQL-Server** 8.4.1                                                 |
| 2024-06-18             | `8.4.0` ([Dockerfile](https://github.com/mosaic-hgw/Docker/blob/8ca53f507d18361bca5fc3e824630f7a813590a8/image/mysql/Dockerfile.mysql.8))                            | **MySQL-Server** 8.4.0                                                                               |
| 2024-03-05<br><br>     | `8.3.0` ([Dockerfile](https://github.com/mosaic-hgw/Docker/blob/5c561547b1f3f6edf02a8a84c786e48868298d33/image/mysql/Dockerfile.mysql.8))<br><br>                    | **Debian** 12.5 "bookworm"<br>**MySQL-Server** 8.3.0                                                 |
